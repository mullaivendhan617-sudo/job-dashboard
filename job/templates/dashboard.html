<!DOCTYPE html>
<html>
<head>
  <title>SQL Server Job Monitoring Dashboard</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Styling -->
  <style>
    body {
      background: #f4f7fb;
      font-family: "Segoe UI", Arial, sans-serif;
    }
    .header-section {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 25px;
    }
    .header-section img {
      height: 50px;
      object-fit: contain;
    }
    h3 {
      font-weight: 700;
      color: #003366;
      margin: 0;
    }
    .filter-bar {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .filter-bar input {
      width: 240px;
      border-radius: 8px;
      padding: 8px;
    }
    #lastUpdated {
      text-align: center;
      font-size: 14px;
      color: #444;
      margin-bottom: 10px;
    }
    table {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      font-size: 14px;
      transition: opacity 0.5s;
    }
    tr:nth-child(even) {
      background: #eef5ff;
    }
    .details-cell {
      max-width: 600px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .badge-success {
      background: #2ecc71 !important;
    }
    .badge-danger {
      background: #e74c3c !important;
    }
    .badge-warning {
      background: #f1c40f !important;
      color: #000 !important;
    }
    tr.failed td {
      background-color: #ffebeb !important;
    }
    tr.success td {
      background-color: #e8ffe8 !important;
    }
    tr.running td {
      background-color: #fff8d1 !important;
    }
    .subrow {
      background: #fafafa;
    }
    .command-cell {
      white-space: pre-wrap;
      word-break: break-word;
      font-family: Consolas, monospace;
      font-size: 13px;
    }
  </style>
</head>

<body class="p-4">

  <!-- Header -->
  <div class="header-section">
    <img src="/static/Lyca_Mobile_Logo.jpg" alt="Lyca Logo">
    <h3>SQL Server Job Monitoring Dashboard</h3>
  </div>

  <!-- Filters -->
  <div class="filter-bar">
    <input type="text" id="jobSearch" class="form-control" placeholder="Search Job Name...">
    <input type="text" id="statusSearch" class="form-control" placeholder="Search Status (Success / Failed / Running)...">
    <input type="text" id="freqSearch" class="form-control" placeholder="Search Frequency (Daily / Weekly / Monthly)...">
  </div>

  <!-- Last Updated -->
  <div id="lastUpdated">Last updated at: <span id="updateTime"></span></div>

  <!-- Job Table -->
  <table class="table table-bordered table-hover" id="jobTable">
    <tr class="table-primary">
      <th>Job Name</th>
      <th>Last Run</th>
      <th>Status</th>
      <th>Schedule Days</th>
      <th>Schedule Times</th>
      <th>Failure Details</th>
    </tr>

    {% for j in jobs %}
    <tr class="
      {% if j.CurrentStatus == 'Succeeded' %}success
      {% elif j.CurrentStatus == 'Failed' %}failed
      {% elif j.CurrentStatus == 'Running' %}running
      {% endif %}
    ">
      <td><a href="#" onclick="toggleProcedures(this, '{{ j.JobName }}');return false;">{{ j.JobName }}</a></td>
      <td>{{ j.LastRunDateTime }}</td>
      <td>
        {% if j.CurrentStatus == 'Succeeded' %}
          <span class="badge badge-success">‚úÖ Success</span>
        {% elif j.CurrentStatus == 'Failed' %}
          <span class="badge badge-danger">‚ùå Failed</span>
        {% elif j.CurrentStatus == 'Running' %}
          <span class="badge badge-warning">‚è≥ Running</span>
        {% else %}
          {{ j.CurrentStatus }}
        {% endif %}
      </td>
      <td>{{ j.ScheduleDays }}</td>
      <td>{{ j.ScheduleTimes }}</td>
      <td class="details-cell">{{ j.FailureDetails }}</td>
    </tr>
    {% endfor %}
  </table>

  <!-- Scripts -->
  <script>
    /* üîç Filtering Logic */
    function filterTable(){
      const job=document.getElementById("jobSearch").value.toLowerCase();
      const status=document.getElementById("statusSearch").value.toLowerCase();
      const freq=document.getElementById("freqSearch").value.toLowerCase();
      document.querySelectorAll("#jobTable tr").forEach((row,i)=>{
        if(i===0)return;
        const name=row.cells[0].innerText.toLowerCase();
        const st=row.cells[2].innerText.toLowerCase();
        const freqcol=row.cells[3].innerText.toLowerCase();
        row.style.display=(name.includes(job)&&st.includes(status)&&freqcol.includes(freq))?"":"none";
      });
    }
    jobSearch.onkeyup=statusSearch.onkeyup=freqSearch.onkeyup=filterTable;

    /* üìÇ Expand job for procedures */
    async function toggleProcedures(link, jobName){
      const row=link.closest("tr");
      const existing=row.nextElementSibling;
      if(existing && existing.classList.contains("subrow")){ existing.remove(); return; }
      const res=await fetch("/job_procedures/"+encodeURIComponent(jobName));
      const data=await res.json();
      let html=`<tr class="subrow"><td colspan="6">
          <b>Steps & Procedures for ${jobName}</b>
          <table class='table table-sm mt-2'>
          <tr><th>ID</th><th>Step Name</th><th>Database</th><th>Step Type</th><th>Command / Procedure Executed</th></tr>`;
      data.forEach(s=>{
          html+=`<tr>
            <td>${s.StepID}</td>
            <td>${s.StepName||''}</td>
            <td>${s.DatabaseName||''}</td>
            <td>${s.StepType||''}</td>
            <td class='command-cell'>${s.CommandExecuted||''}</td>
          </tr>`;
      });
      html+="</table></td></tr>";
      row.insertAdjacentHTML("afterend",html);
    }

    /* üé® Reapply Row Colors */
    function colorizeRows(){
      document.querySelectorAll("#jobTable tr").forEach((row,i)=>{
        if(i===0)return;
        const statusCell=row.cells[2];
        if(!statusCell) return;
        const text=statusCell.innerText.toLowerCase();
        row.classList.remove("failed","success","running");
        if(text.includes("failed")) row.classList.add("failed");
        else if(text.includes("success")) row.classList.add("success");
        else if(text.includes("running")) row.classList.add("running");
      });
    }

    /* üïí Auto Refresh Every 60 sec (without reload) */
    async function refreshData(){
      const expandedJobs=[];
      document.querySelectorAll(".subrow").forEach(r=>{
        const jobName=r.previousElementSibling.querySelector("a").innerText;
        expandedJobs.push(jobName);
      });
      const job=document.getElementById("jobSearch").value;
      const status=document.getElementById("statusSearch").value;
      const freq=document.getElementById("freqSearch").value;

      document.querySelector("#jobTable").style.opacity="0.5";

      const res=await fetch(window.location.href);
      const html=await res.text();
      const parser=new DOMParser();
      const doc=parser.parseFromString(html,"text/html");
      const newTable=doc.querySelector("#jobTable").innerHTML;
      document.querySelector("#jobTable").innerHTML=newTable;

      document.getElementById("jobSearch").value=job;
      document.getElementById("statusSearch").value=status;
      document.getElementById("freqSearch").value=freq;
      filterTable();
      for(const name of expandedJobs){
        const link=[...document.querySelectorAll("#jobTable a")].find(a=>a.innerText===name);
        if(link){ toggleProcedures(link,name); }
      }
      colorizeRows();

      document.querySelector("#jobTable").style.opacity="1";
      document.getElementById("updateTime").textContent = new Date().toLocaleTimeString();
    }

    /* Initial coloring + timer */
    colorizeRows();
    refreshData();
    setInterval(refreshData,60000); // 60 seconds
  </script>
</body>
</html>
